# YouTube 直播流管理器

这是一个功能强大的直播流管理工具，能够将来自 YouTube 的视频以播放列表的形式，不间断地推送到指定的 RTMP 直播服务器。项目包含一个纯后端的 Python 核心和一个用于交互的单页 Web 前端。

## 简介

该项目旨在解决自动化直播的需求。用户可以通过一个简单的 Web 界面，将多个视频链接添加到一个队列中。系统会自动获取视频的真实流媒体地址，使用 `ffmpeg` 进行转码，并添加动态信息水印（如当前播放标题、播放列表、系统性能信息等），然后将处理后的视频流推送到一个或多个预设的直播终端。当播放列表为空时，系统会自动推流一个待机画面，确保直播永不中断。

## 主要功能

- **YouTube 支持**: 支持从 YouTube 获取视频源。
- **多终端管理**: 可同时管理多个独立的直播推流终端（例如：主线路、备用线路1、备用线路2）。
- **自动化播放列表**: 自动按顺序播放队列中的视频，一个结束后无缝衔接下一个。
- **动态水印**: 在直播画面上实时显示可定制的水印信息，包括：
    - 视频标题和基本信息
    - 即将播放的视频队列
    - 服务器实时性能（CPU、内存、网络速度）
- **硬件加速**: 利用 `ffmpeg` 的 VA-API 功能进行视频转码，显著降低 CPU 占用。
- **待机画面**: 当播放列表为空时，自动切换到包含实时信息的待机画面，维持直播流的在线状态。
- **Web 操作界面**: 提供一个直观的单页 Web 应用 (`streamer.html`)，方便用户：
    - 选择要操作的直播终端。
    - 添加/移除播放列表中的视频。
    - 实时查看直播状态和 `ffmpeg` 日志。
    - 手动终止当前直播。
- **国际化**: Web 界面支持多种语言（英文、简体中文、繁體中文、日文）。

## 项目架构

- **`backend.py`**: **核心后端服务**。一个基于 Flask 的 Web 应用，作为 API 服务器。它初始化并管理多个 `Streamer` 实例，每个实例对应一个直播终端。它处理所有来自前端的 HTTP 请求。
- **`streamer.py`**: **单个直播流处理器**。这是核心逻辑所在，封装了与单个直播流相关的所有操作。它调用 `yt-dlp` 来解析视频信息，并管理 `ffmpeg` 子进程以进行推流。它还包含一个后台工作线程，用于维护播放列表和实现自动播放。
- **`perfmonitor.py`**: **性能监控器**。一个辅助模块，使用 `psutil` 库来监控系统资源，并为水印提供格式化的性能字符串。
- **`streamer.html`**: **前端用户界面**。一个无需构建的纯 HTML/CSS/JavaScript 单页应用。用户通过此页面与后端 API 交互来管理直播。

## 安装与配置

### 依赖环境

- Python 3.x
- `ffmpeg` (需要编译支持 VA-API)
- `yt-dlp`
- Python 库: `flask`, `psutil`

### 安装步骤

1.  **安装 Python 库**:
    ```bash
    pip install flask psutil
    ```

2.  **安装 `yt-dlp`**:
    请参照 yt-dlp 官方文档 进行安装。

3.  **准备配置文件**:
    - **Cookie 文件**: 将你的 YouTube 登录后的 Cookie 保存为 `www.youtube.com_cookies.txt` 文件，并放置在项目根目录。这对于下载有登录限制或需要会员的视频至关重要。
    - **字体文件**: 准备一个 TrueType 字体文件（`.ttf` 或 `.ttc`），并将其命名为 `font.ttc` 放置在项目根目录，用于 `ffmpeg` 水印渲染。

4.  **配置 `streamer.py` (如果需要)**:
    - 打开 `streamer.py` 文件，你可以根据需要修改 `RTMP_BASE_URL` 的默认值，以指向你自己的 RTMP 服务器地址。

### 运行

1.  **启动后端服务**:
    ```bash
    python3 backend.py
    ```
    服务默认在 `0.0.0.0:8083` 上运行。

2.  **访问前端页面**:
    - 你需要一个 Web 服务器（如 Nginx, Caddy 或 Apache）来托管 `streamer.html` 文件。
    - 配置该 Web 服务器将 `/ytapi` 路径反向代理到后端服务 `http://127.0.0.1:8083`。
    - 通过浏览器访问 `streamer.html` 所在的地址。

## API 接口

所有 API 请求都需要一个 `endpoint` 查询参数来指定操作哪个直播终端 (例如 `?endpoint=yt`)。

- `GET /ytapi/enqueue`: 添加一个视频到队列。
  - **参数**: `url`, `bitrate`, `audioOnly` (true/false), `FPS`, `GOP`
- `GET /ytapi/dequeue`: 从队列中移除一个视频。
  - **参数**: `index`
- `GET /ytapi/status`: 获取指定终端的详细状态，包括正在播放的视频、队列内容、`ffmpeg` 日志等。
- `GET /ytapi/terminate`: 立即终止指定终端的当前推流进程。

## 注意事项

- `ytapi.py` 和 `ytapi.sh` 是项目的早期版本，当前已被 `backend.py` 和 `streamer.py` 的组合所取代，可以安全地忽略或删除。
- 确保运行后端服务的服务器具有 VA-API 所需的硬件和驱动环境（通常是 Intel GPU）。